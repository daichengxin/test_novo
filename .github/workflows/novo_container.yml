name: NovA CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write  # 推 GHCR 必须

    steps:
      # 1️⃣ Checkout
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Pull NVIDIA CUDA base image
      - name: Pull CUDA 12.1 Base Image
        run: docker pull nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

      # 4️⃣ Build Docker image
      - name: Build RNovA Docker Image
        run: |
          docker build -t rnova-ci -f Dockerfile .

#      # 5️⃣ Run container and install uv + deps
#      - name: Run container for testing
#        run: |
#          docker run --rm --gpus all \
#            -v $GITHUB_WORKSPACE:/workspace \
#            rnova-ci bash -c "
#              apt-get update && apt-get install -y curl python3.11 python3.11-venv python3-pip build-essential ninja-build
#              curl -LsSf https://astral.sh/uv/install.sh | sh
#              export PATH=$HOME/.cargo/bin:$PATH
#              uv python pin 3.11
#              uv venv .venv
#              source .venv/bin/activate
#              uv pip install torch==2.3.1 --index-url https://download.pytorch.org/whl/cu121
#              uv pip install flash-attn --no-build-isolation
#              python -c 'import flash_attn; print(\"flash-attn ok\")'
#            "
      - name: Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/daichengxin/nova:latest